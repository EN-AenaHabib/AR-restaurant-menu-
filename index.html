<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>AR Restaurant Menu</title>

  <!-- MindAR + Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.prod.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #000; font-family: 'Segoe UI', sans-serif; overflow: hidden; }

    /* ‚îÄ‚îÄ Loading Screen ‚îÄ‚îÄ */
    #loading-screen {
      position: fixed; inset: 0; z-index: 9999;
      background: linear-gradient(135deg, #1a0a00 0%, #3d1a00 50%, #1a0a00 100%);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center; gap: 20px;
    }
    #loading-screen .logo {
      font-size: 52px; margin-bottom: 8px;
      animation: pulse 1.5s ease-in-out infinite;
    }
    #loading-screen h1 {
      color: #ff9b3c; font-size: 26px; font-weight: 800;
      letter-spacing: 2px; text-transform: uppercase;
    }
    #loading-screen p { color: #ffcc99; font-size: 14px; opacity: 0.8; }
    .loader-bar {
      width: 220px; height: 4px; background: #333;
      border-radius: 4px; overflow: hidden; margin-top: 10px;
    }
    .loader-fill {
      height: 100%; width: 0%;
      background: linear-gradient(90deg, #ff6b00, #ff9b3c);
      border-radius: 4px;
      animation: load 2.5s ease forwards;
    }
    @keyframes load { to { width: 100%; } }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.1)} }

    /* ‚îÄ‚îÄ Scan Screen ‚îÄ‚îÄ */
    #scan-screen {
      position: fixed; inset: 0; z-index: 9998;
      background: linear-gradient(135deg, #0d0500 0%, #2b0f00 100%);
      display: none; flex-direction: column;
      align-items: center; justify-content: center; gap: 18px;
      padding: 30px;
    }
    #scan-screen .scan-icon {
      width: 200px; height: 200px; border-radius: 24px;
      border: 3px solid #ff6b00;
      display: flex; align-items: center; justify-content: center;
      font-size: 80px; position: relative;
      animation: scanPulse 2s ease-in-out infinite;
    }
    #scan-screen .scan-icon::before, #scan-screen .scan-icon::after {
      content: ''; position: absolute;
      width: 30px; height: 30px;
      border-color: #ff9b3c; border-style: solid;
    }
    #scan-screen .scan-icon::before {
      top: -3px; left: -3px;
      border-width: 4px 0 0 4px; border-radius: 6px 0 0 0;
    }
    #scan-screen .scan-icon::after {
      bottom: -3px; right: -3px;
      border-width: 0 4px 4px 0; border-radius: 0 0 6px 0;
    }
    .scan-line {
      position: absolute; width: 80%; height: 2px;
      background: linear-gradient(90deg, transparent, #ff6b00, transparent);
      animation: scanLine 2s linear infinite;
    }
    @keyframes scanLine {
      0% { top: 10%; } 100% { top: 90%; }
    }
    @keyframes scanPulse {
      0%,100%{box-shadow:0 0 20px #ff6b0033}
      50%{box-shadow:0 0 50px #ff6b0088}
    }
    #scan-screen h2 { color: #ff9b3c; font-size: 22px; font-weight: 700; }
    #scan-screen p { color: #ffcc9988; font-size: 13px; text-align: center; max-width: 280px; }
    #start-btn {
      margin-top: 10px; padding: 16px 48px;
      background: linear-gradient(135deg, #ff6b00, #ff9b3c);
      color: white; border: none; border-radius: 50px;
      font-size: 16px; font-weight: 700; letter-spacing: 1px;
      cursor: pointer; text-transform: uppercase;
      box-shadow: 0 8px 30px #ff6b0055;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    #start-btn:active { transform: scale(0.95); }

    /* ‚îÄ‚îÄ AR Canvas ‚îÄ‚îÄ */
    #ar-container {
      position: fixed; inset: 0; z-index: 1;
      display: none;
    }

    /* ‚îÄ‚îÄ HUD Controls ‚îÄ‚îÄ */
    #hud {
      position: fixed; z-index: 100;
      display: none;
    }

    /* Top bar */
    #top-bar {
      position: fixed; top: 0; left: 0; right: 0; z-index: 200;
      display: none;
      background: linear-gradient(180deg, rgba(0,0,0,0.85) 0%, transparent 100%);
      padding: 16px 20px 30px;
      flex-direction: row; align-items: center; justify-content: space-between;
    }
    #top-bar .restaurant-name {
      color: #ff9b3c; font-size: 18px; font-weight: 800;
      letter-spacing: 1px;
    }
    #top-bar .tag {
      background: #ff6b00; color: white;
      font-size: 10px; font-weight: 700;
      padding: 4px 10px; border-radius: 20px;
      letter-spacing: 1px; text-transform: uppercase;
    }

    /* Right controls */
    #right-controls {
      position: fixed; right: 14px; top: 50%;
      transform: translateY(-50%);
      z-index: 200; display: none;
      flex-direction: column; gap: 10px;
    }
    .ctrl-btn {
      width: 48px; height: 48px; border-radius: 14px;
      background: rgba(0,0,0,0.75);
      border: 1.5px solid rgba(255,107,0,0.5);
      color: white; font-size: 20px;
      display: flex; align-items: center; justify-content: center;
      cursor: pointer; backdrop-filter: blur(10px);
      transition: all 0.2s; user-select: none;
    }
    .ctrl-btn:active, .ctrl-btn.active {
      background: rgba(255,107,0,0.5);
      border-color: #ff6b00;
      transform: scale(0.93);
    }
    .ctrl-label {
      color: #ff9b3c88; font-size: 9px; text-align: center;
      margin-top: -6px; letter-spacing: 0.5px;
    }

    /* Bottom controls */
    #bottom-controls {
      position: fixed; bottom: 0; left: 0; right: 0;
      z-index: 200; display: none;
      background: linear-gradient(0deg, rgba(0,0,0,0.9) 0%, transparent 100%);
      padding: 20px 20px 28px;
      flex-direction: column; gap: 12px;
    }

    /* Size slider */
    #size-row {
      display: flex; align-items: center; gap: 12px;
    }
    #size-row label { color: #ff9b3c; font-size: 12px; font-weight: 600; min-width: 36px; }
    #size-slider {
      flex: 1; -webkit-appearance: none; height: 4px;
      background: linear-gradient(90deg, #ff6b00 var(--val,50%), #333 var(--val,50%));
      border-radius: 4px; outline: none;
    }
    #size-slider::-webkit-slider-thumb {
      -webkit-appearance: none; width: 20px; height: 20px;
      border-radius: 50%; background: #ff9b3c;
      box-shadow: 0 2px 8px #ff6b0088; cursor: pointer;
    }
    #size-val { color: #ffcc99; font-size: 12px; min-width: 32px; text-align: right; }

    /* Menu category pills */
    #menu-pills {
      display: flex; gap: 8px; overflow-x: auto;
      scrollbar-width: none; padding-bottom: 2px;
    }
    #menu-pills::-webkit-scrollbar { display: none; }
    .pill {
      white-space: nowrap; padding: 8px 18px;
      border-radius: 30px; font-size: 12px; font-weight: 700;
      cursor: pointer; transition: all 0.2s;
      border: 1.5px solid rgba(255,107,0,0.4);
      color: #ff9b3caa; background: rgba(0,0,0,0.5);
      letter-spacing: 0.5px;
    }
    .pill.active {
      background: linear-gradient(135deg, #ff6b00, #ff9b3c);
      color: white; border-color: transparent;
      box-shadow: 0 4px 16px #ff6b0055;
    }

    /* ‚îÄ‚îÄ Info Card ‚îÄ‚îÄ */
    #info-card {
      position: fixed; bottom: 100px; left: 50%;
      transform: translateX(-50%) translateY(120%);
      z-index: 300; width: calc(100% - 40px); max-width: 380px;
      background: rgba(10,4,0,0.95);
      border: 1.5px solid rgba(255,107,0,0.4);
      border-radius: 24px; padding: 22px;
      backdrop-filter: blur(20px);
      box-shadow: 0 20px 60px rgba(255,107,0,0.2);
      transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    #info-card.show {
      transform: translateX(-50%) translateY(0);
    }
    #info-card .card-header {
      display: flex; justify-content: space-between; align-items: flex-start;
      margin-bottom: 12px;
    }
    #info-card h3 { color: #ff9b3c; font-size: 20px; font-weight: 800; }
    #info-card .price {
      background: linear-gradient(135deg, #ff6b00, #ff9b3c);
      color: white; padding: 6px 14px; border-radius: 20px;
      font-size: 15px; font-weight: 700;
    }
    #info-card p { color: #ffcc9988; font-size: 13px; line-height: 1.6; margin-bottom: 14px; }
    #info-card .tags { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 16px; }
    #info-card .food-tag {
      background: rgba(255,107,0,0.15);
      border: 1px solid rgba(255,107,0,0.3);
      color: #ff9b3caa; font-size: 11px;
      padding: 4px 10px; border-radius: 20px;
    }
    #close-card {
      position: absolute; top: 16px; right: 16px;
      width: 32px; height: 32px; border-radius: 50%;
      background: rgba(255,107,0,0.2); border: none;
      color: #ff9b3c; font-size: 18px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
    }

    /* ‚îÄ‚îÄ Instructions Toast ‚îÄ‚îÄ */
    #toast {
      position: fixed; top: 80px; left: 50%;
      transform: translateX(-50%);
      z-index: 400; background: rgba(0,0,0,0.85);
      color: #ffcc99; font-size: 13px; padding: 10px 20px;
      border-radius: 30px; border: 1px solid rgba(255,107,0,0.3);
      backdrop-filter: blur(10px);
      transition: opacity 0.5s;
      white-space: nowrap;
    }

    /* ‚îÄ‚îÄ No tracking indicator ‚îÄ‚îÄ */
    #tracking-indicator {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      z-index: 150; text-align: center;
      display: none;
      pointer-events: none;
    }
    #tracking-indicator .finder {
      width: 180px; height: 180px; margin: 0 auto 14px;
      border: 2px dashed rgba(255,107,0,0.5);
      border-radius: 16px;
      display: flex; align-items: center; justify-content: center;
      font-size: 50px;
      animation: dashedPulse 1.5s ease-in-out infinite;
    }
    @keyframes dashedPulse {
      0%,100%{border-color:rgba(255,107,0,0.3); transform:scale(1)}
      50%{border-color:rgba(255,107,0,0.8); transform:scale(1.03)}
    }
    #tracking-indicator p { color: #ffcc9977; font-size: 13px; }
  </style>
</head>
<body>

<!-- LOADING -->
<div id="loading-screen">
  <div class="logo">üçï</div>
  <h1>AR Menu</h1>
  <p>Preparing your experience...</p>
  <div class="loader-bar"><div class="loader-fill"></div></div>
</div>

<!-- SCAN START SCREEN -->
<div id="scan-screen">
  <div class="scan-icon">
    üçï
    <div class="scan-line"></div>
  </div>
  <h2>Point at QR / Marker</h2>
  <p>Place the printed marker on your table and point your camera at it to see the AR menu</p>
  <button id="start-btn" onclick="startAR()">Start AR Camera</button>
</div>

<!-- AR CONTAINER -->
<div id="ar-container"></div>

<!-- TOP BAR -->
<div id="top-bar">
  <span class="restaurant-name">üçΩÔ∏è Bella Vista</span>
  <span class="tag">AR Menu</span>
</div>

<!-- TRACKING LOST INDICATOR -->
<div id="tracking-indicator">
  <div class="finder">üîç</div>
  <p>Point camera at the marker</p>
</div>

<!-- RIGHT CONTROLS -->
<div id="right-controls">
  <div>
    <div class="ctrl-btn" id="btn-move" onclick="setMode('move')" title="Move">‚úã</div>
    <div class="ctrl-label">MOVE</div>
  </div>
  <div>
    <div class="ctrl-btn" id="btn-rotate" onclick="setMode('rotate')" title="Rotate">üîÑ</div>
    <div class="ctrl-label">ROTATE</div>
  </div>
  <div>
    <div class="ctrl-btn active" id="btn-view" onclick="setMode('view')" title="View">üëÅÔ∏è</div>
    <div class="ctrl-label">VIEW</div>
  </div>
  <div>
    <div class="ctrl-btn" onclick="resetTransform()" title="Reset">‚Ü∫</div>
    <div class="ctrl-label">RESET</div>
  </div>
</div>

<!-- BOTTOM CONTROLS -->
<div id="bottom-controls">
  <div id="size-row">
    <label>SIZE</label>
    <input type="range" id="size-slider" min="1" max="100" value="50"
           oninput="onSizeChange(this.value)" />
    <span id="size-val">1.0√ó</span>
  </div>
  <div id="menu-pills">
    <div class="pill active" onclick="filterMenu('all', this)">üçΩÔ∏è All</div>
    <div class="pill" onclick="filterMenu('pizza', this)">üçï Pizza</div>
    <div class="pill" onclick="filterMenu('burger', this)">üçî Burgers</div>
    <div class="pill" onclick="filterMenu('pasta', this)">üçù Pasta</div>
    <div class="pill" onclick="filterMenu('drinks', this)">ü•§ Drinks</div>
  </div>
</div>

<!-- INFO CARD -->
<div id="info-card">
  <button id="close-card" onclick="closeCard()">‚úï</button>
  <div class="card-header">
    <h3 id="card-name">Margherita Pizza</h3>
    <span class="price" id="card-price">$12.99</span>
  </div>
  <p id="card-desc">Fresh tomato sauce, mozzarella, and basil on a crispy wood-fired crust.</p>
  <div class="tags" id="card-tags"></div>
</div>

<!-- TOAST -->
<div id="toast">üéØ Tracking marker ‚Äî AR menu will appear!</div>

<script>
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MENU DATA
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MENU = [
  {
    id: 1, category: 'pizza',
    name: 'Margherita Pizza', price: '$12.99',
    desc: 'Fresh tomato sauce, mozzarella, and basil on a crispy wood-fired crust.',
    tags: ['Vegetarian', 'Classic', 'Best Seller'],
    model: 'pizza.glb',
    scale: 0.10,
    position: [-0.35, 0.08, -0.1],
    emoji: 'üçï'
  },
  {
    id: 2, category: 'pizza',
    name: 'Pepperoni Supreme', price: '$14.99',
    desc: 'Loaded with premium pepperoni, extra cheese, and house-made tomato sauce.',
    tags: ['Spicy', 'Popular'],
    model: 'pizza.glb',
    scale: 0.10,
    position: [0.35, 0.08, -0.1],
    emoji: 'üçï'
  },
  {
    id: 3, category: 'burger',
    name: 'Classic Cheeseburger', price: '$9.99',
    desc: 'Juicy beef patty with cheddar, lettuce, tomato, and our secret sauce.',
    tags: ['Juicy', 'Comfort Food'],
    model: 'pizza.glb', // replace with burger.glb when available
    scale: 0.09,
    position: [0, 0.08, 0.35],
    emoji: 'üçî'
  },
];

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// GLOBALS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let mindarThree, renderer, scene, camera;
let anchorGroup;
let menuObjects = [];        // { mesh, data }
let currentMode = 'view';    // 'view' | 'move' | 'rotate'
let baseScale = 1.0;
let isTracking = false;
let isDragging = false;
let lastTouch = { x: 0, y: 0 };
let lastPinchDist = 0;
let touchCount = 0;

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// LOADING ‚Üí SCAN SCREEN
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('load', () => {
  setTimeout(() => {
    document.getElementById('loading-screen').style.display = 'none';
    document.getElementById('scan-screen').style.display = 'flex';
  }, 2800);
});

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// START AR
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startAR() {
  document.getElementById('scan-screen').style.display = 'none';
  document.getElementById('ar-container').style.display = 'block';
  document.getElementById('top-bar').style.display = 'flex';
  document.getElementById('right-controls').style.display = 'flex';
  document.getElementById('bottom-controls').style.display = 'flex';
  document.getElementById('tracking-indicator').style.display = 'block';

  showToast('üì± Scanning for marker...');

  try {
    mindarThree = new window.MINDAR.IMAGE.MindARThree({
      container: document.getElementById('ar-container'),
      imageTargetSrc: 'targets.mind',
      uiLoading: 'no',
      uiScanning: 'no',
      uiError: 'no',
    });

    ({ renderer, scene, camera } = mindarThree);
    renderer.shadowMap.enabled = true;

    // Lighting
    const ambient = new THREE.AmbientLight(0xffffff, 0.8);
    scene.add(ambient);
    const dir = new THREE.DirectionalLight(0xffddaa, 1.2);
    dir.position.set(0.5, 1, 0.5);
    scene.add(dir);
    const point = new THREE.PointLight(0xff9b3c, 0.6, 2);
    point.position.set(0, 0.5, 0);
    scene.add(point);

    // Anchor (index 0 = first target in .mind file)
    const anchor = mindarThree.addAnchor(0);
    anchorGroup = anchor.group;

    // Track found/lost
    anchor.onTargetFound = () => {
      isTracking = true;
      document.getElementById('tracking-indicator').style.display = 'none';
      showToast('‚úÖ Menu detected! Tap a dish to see details');
    };
    anchor.onTargetLost = () => {
      isTracking = false;
      document.getElementById('tracking-indicator').style.display = 'block';
      showToast('üîç Move camera back to the marker');
    };

    // Load 3D models
    const loader = new THREE.GLTFLoader();
    const activeItems = MENU.filter(item => item.category !== '__hidden');

    for (const item of activeItems) {
      await new Promise((resolve) => {
        loader.load(
          item.model,
          (gltf) => {
            const model = gltf.scene;
            model.scale.setScalar(item.scale);
            model.position.set(...item.position);
            model.userData = { menuItem: item };

            // Floating animation offset
            model.userData.floatOffset = Math.random() * Math.PI * 2;

            anchorGroup.add(model);
            menuObjects.push({ mesh: model, data: item });

            // Label below model
            addLabel(item, anchorGroup);
            resolve();
          },
          undefined,
          () => {
            // Fallback: placeholder box if model fails to load
            const geo = new THREE.BoxGeometry(0.12, 0.12, 0.12);
            const mat = new THREE.MeshStandardMaterial({
              color: 0xff6b00, roughness: 0.4, metalness: 0.2
            });
            const box = new THREE.Mesh(geo, mat);
            box.position.set(...item.position);
            box.userData = { menuItem: item };
            box.userData.floatOffset = Math.random() * Math.PI * 2;
            anchorGroup.add(box);
            menuObjects.push({ mesh: box, data: item });
            addLabel(item, anchorGroup);
            resolve();
          }
        );
      });
    }

    // Touch / click interactions
    setupInteractions();

    // Start
    await mindarThree.start();

    // Render loop
    let t = 0;
    renderer.setAnimationLoop(() => {
      t += 0.016;
      menuObjects.forEach(({ mesh }) => {
        const off = mesh.userData.floatOffset || 0;
        const base = mesh.userData.baseY !== undefined
          ? mesh.userData.baseY
          : (() => { mesh.userData.baseY = mesh.position.y; return mesh.position.y; })();
        mesh.position.y = base + Math.sin(t * 1.5 + off) * 0.018;
        mesh.rotation.y += 0.008;
      });
      renderer.render(scene, camera);
    });

  } catch (err) {
    console.error(err);
    showToast('‚ùå Camera error. Please allow camera access and reload.');
  }
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// LABEL (plate + text sprite)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addLabel(item, parent) {
  // Plate disc
  const geo = new THREE.CylinderGeometry(0.1, 0.1, 0.008, 32);
  const mat = new THREE.MeshStandardMaterial({
    color: 0xfff5e4, roughness: 0.5, metalness: 0.1
  });
  const plate = new THREE.Mesh(geo, mat);
  plate.position.set(item.position[0], item.position[1] - 0.06, item.position[2]);
  parent.add(plate);

  // Canvas-based name label
  const canvas = document.createElement('canvas');
  canvas.width = 512; canvas.height = 128;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = 'rgba(0,0,0,0)';
  ctx.fillRect(0, 0, 512, 128);
  ctx.font = 'bold 36px Arial';
  ctx.fillStyle = '#ff9b3c';
  ctx.textAlign = 'center';
  ctx.fillText(item.emoji + ' ' + item.name, 256, 60);
  ctx.font = '28px Arial';
  ctx.fillStyle = '#ffcc99aa';
  ctx.fillText(item.price, 256, 100);

  const tex = new THREE.CanvasTexture(canvas);
  const spriteMat = new THREE.SpriteMaterial({ map: tex, transparent: true });
  const sprite = new THREE.Sprite(spriteMat);
  sprite.scale.set(0.4, 0.1, 1);
  sprite.position.set(item.position[0], item.position[1] + 0.22, item.position[2]);
  parent.add(sprite);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// INTERACTIONS ‚Äî tap, pinch-zoom, drag
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupInteractions() {
  const canvas = renderer.domElement;

  // ‚îÄ‚îÄ TAP to show info card (view mode) ‚îÄ‚îÄ
  function handleTap(clientX, clientY) {
    if (currentMode !== 'view') return;
    if (!isTracking) return;

    const rect = canvas.getBoundingClientRect();
    const mouse = new THREE.Vector2(
      ((clientX - rect.left) / rect.width) * 2 - 1,
      -((clientY - rect.top) / rect.height) * 2 + 1
    );
    const ray = new THREE.Raycaster();
    ray.setFromCamera(mouse, camera);
    const meshes = menuObjects.map(o => o.mesh);
    const hits = ray.intersectObjects(meshes, true);
    if (hits.length > 0) {
      let obj = hits[0].object;
      while (obj && !obj.userData.menuItem) obj = obj.parent;
      if (obj && obj.userData.menuItem) showCard(obj.userData.menuItem);
    }
  }

  canvas.addEventListener('click', (e) => {
    if (!isDragging) handleTap(e.clientX, e.clientY);
    isDragging = false;
  });

  // ‚îÄ‚îÄ TOUCH: move / rotate / pinch ‚îÄ‚îÄ
  let touchStartX = 0, touchStartY = 0;
  let rotationStart = { x: 0, y: 0 };

  canvas.addEventListener('touchstart', (e) => {
    touchCount = e.touches.length;
    isDragging = false;

    if (e.touches.length === 1) {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      lastTouch = { x: touchStartX, y: touchStartY };
      rotationStart = {
        x: anchorGroup.rotation.x,
        y: anchorGroup.rotation.y,
      };
    }
    if (e.touches.length === 2) {
      lastPinchDist = getPinchDist(e);
    }
  }, { passive: true });

  canvas.addEventListener('touchmove', (e) => {
    if (e.touches.length === 1) {
      const dx = e.touches[0].clientX - lastTouch.x;
      const dy = e.touches[0].clientY - lastTouch.y;

      if (Math.abs(dx) > 4 || Math.abs(dy) > 4) isDragging = true;

      if (currentMode === 'move' && isTracking) {
        anchorGroup.position.x += dx * 0.0008;
        anchorGroup.position.z += dy * 0.0008;
      } else if (currentMode === 'rotate' && isTracking) {
        anchorGroup.rotation.y += dx * 0.012;
        anchorGroup.rotation.x += dy * 0.008;
      }
      lastTouch = { x: e.touches[0].clientX, y: e.touches[0].clientY };
    }

    // Pinch to scale
    if (e.touches.length === 2) {
      const dist = getPinchDist(e);
      const ratio = dist / lastPinchDist;
      baseScale = Math.min(Math.max(baseScale * ratio, 0.2), 5.0);
      anchorGroup.scale.setScalar(baseScale);
      lastPinchDist = dist;
      updateSliderUI(baseScale);
      isDragging = true;
      e.preventDefault();
    }
  }, { passive: false });

  canvas.addEventListener('touchend', (e) => {
    if (e.touches.length === 0 && !isDragging) {
      // Single tap
      const lastT = e.changedTouches[0];
      handleTap(lastT.clientX, lastT.clientY);
    }
    touchCount = e.touches.length;
  });
}

function getPinchDist(e) {
  const dx = e.touches[0].clientX - e.touches[1].clientX;
  const dy = e.touches[0].clientY - e.touches[1].clientY;
  return Math.sqrt(dx * dx + dy * dy);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MODE BUTTONS
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setMode(mode) {
  currentMode = mode;
  document.querySelectorAll('.ctrl-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('btn-' + mode)?.classList.add('active');

  const msgs = {
    move: '‚úã Drag to move menu on table',
    rotate: 'üîÑ Drag to rotate menu',
    view: 'üëÅÔ∏è Tap a dish to see details',
  };
  showToast(msgs[mode]);
}

function resetTransform() {
  if (!anchorGroup) return;
  anchorGroup.position.set(0, 0, 0);
  anchorGroup.rotation.set(0, 0, 0);
  baseScale = 1.0;
  anchorGroup.scale.setScalar(1.0);
  document.getElementById('size-slider').value = 50;
  updateSliderUI(1.0);
  showToast('‚Ü∫ Reset to original position');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// SIZE SLIDER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onSizeChange(val) {
  // val: 1-100 ‚Üí scale: 0.2 - 3.0
  baseScale = 0.2 + (val / 100) * 2.8;
  if (anchorGroup) anchorGroup.scale.setScalar(baseScale);
  updateSliderUI(baseScale);
}

function updateSliderUI(scale) {
  document.getElementById('size-val').textContent = scale.toFixed(1) + '√ó';
  const pct = ((scale - 0.2) / 2.8 * 100).toFixed(0);
  const slider = document.getElementById('size-slider');
  slider.value = Math.min(100, Math.max(1, pct));
  slider.style.setProperty('--val', pct + '%');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// MENU CATEGORY FILTER
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filterMenu(cat, el) {
  document.querySelectorAll('.pill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');

  menuObjects.forEach(({ mesh, data }) => {
    const visible = cat === 'all' || data.category === cat;
    mesh.visible = visible;
  });

  showToast(cat === 'all' ? 'üçΩÔ∏è Showing all items' : `Showing ${cat} items`);
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// INFO CARD
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showCard(item) {
  document.getElementById('card-name').textContent = item.emoji + ' ' + item.name;
  document.getElementById('card-price').textContent = item.price;
  document.getElementById('card-desc').textContent = item.desc;
  const tagsEl = document.getElementById('card-tags');
  tagsEl.innerHTML = item.tags.map(t => `<span class="food-tag">${t}</span>`).join('');
  document.getElementById('info-card').classList.add('show');
}

function closeCard() {
  document.getElementById('info-card').classList.remove('show');
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// TOAST
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.opacity = '1';
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { t.style.opacity = '0'; }, 3000);
}
</script>
</body>
</html>
