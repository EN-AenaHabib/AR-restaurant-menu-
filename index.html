<!DOCTYPE html>
<html>
<head>
  <title>Bon AppÃ©tit AR Menu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body {
      width: 100%; height: 100%;
      overflow: hidden;
      background: #000;
    }

    video {
      position: fixed !important;
      top: 0 !important; left: 0 !important;
      width: 100vw !important; height: 100vh !important;
      object-fit: cover !important;
      z-index: 0 !important;
      transform: none !important;
      -webkit-transform: none !important;
    }

    canvas {
      position: fixed !important;
      top: 0 !important; left: 0 !important;
      width: 100vw !important; height: 100vh !important;
      z-index: 1 !important;
    }

    a-scene {
      position: fixed !important;
      top: 0 !important; left: 0 !important;
      width: 100vw !important; height: 100vh !important;
    }

    .arjs-loader, .a-loader-title, .a-enter-vr,
    .a-orientation-modal, [data-aframe-default-button] {
      display: none !important;
    }

    #ui-overlay {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #000;
      color: #fff;
      font-family: sans-serif;
      gap: 14px;
      transition: opacity 0.6s ease;
    }

    #ui-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .spinner {
      width: 50px; height: 50px;
      border: 4px solid rgba(255,255,255,0.15);
      border-top-color: #fff;
      border-radius: 50%;
      animation: spin 0.9s linear infinite;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    #ui-overlay p { font-size: 16px; opacity: 0.85; }
    #ui-overlay small { font-size: 12px; opacity: 0.5; text-align: center; padding: 0 30px; }

    #hint {
      position: fixed;
      bottom: 28px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.55);
      color: #fff;
      font-family: sans-serif;
      font-size: 13px;
      padding: 8px 18px;
      border-radius: 20px;
      z-index: 100;
      pointer-events: none;
      white-space: nowrap;
    }
  </style>
</head>
<body>

<div id="ui-overlay">
  <div class="spinner"></div>
  <p>Loading AR Menuâ€¦</p>
  <small>Allow camera access when prompted</small>
</div>

<div id="hint">ðŸ“· Point camera at a menu marker</div>

<a-scene
  embedded
  vr-mode-ui="enabled: false"
  loading-screen="enabled: false"
  renderer="antialias: true; alpha: true; logarithmicDepthBuffer: true;"
  arjs="sourceType: webcam; facingMode: environment; debugUIEnabled: false; detectionMode: mono_and_matrix; trackingMethod: best;"
>
  <!--
    KEY FIX: Removed <a-assets> preloading entirely.
    On Android Chrome, the asset preloader frequently times out or silently fails for GLBs.
    Loading models directly via src on each entity is far more reliable on mobile.
  -->

  <a-entity light="type: ambient; color: #ffffff; intensity: 3;"></a-entity>
  <a-entity light="type: directional; color: #ffffff; intensity: 2;" position="0 5 5"></a-entity>

  <a-marker type="pattern" url="pattern-images.patt"
    smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
    <a-entity gltf-model="pizza.glb" scale="0.05 0.05 0.05" position="0 0 0"></a-entity>
  </a-marker>

  <a-marker type="pattern" url="pattern-latte.patt"
    smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
    <a-entity gltf-model="iced_matcha.glb" scale="0.5 0.5 0.5" position="0 0 0"></a-entity>
  </a-marker>

  <a-marker type="pattern" url="pattern-donut.patt"
    smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
    <a-entity gltf-model="maple_donut.glb" scale="0.8 0.8 0.8" position="0 0 0"></a-entity>
  </a-marker>

  <a-marker type="pattern" url="pattern-hotchoco.patt"
    smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
    <a-entity gltf-model="hot_chocolate.glb" scale="0.5 0.5 0.5" position="0 0 0"></a-entity>
  </a-marker>

  <a-marker type="pattern" url="pattern-rollcake.patt"
    smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
    <a-entity gltf-model="sakura_cake_roll.glb" scale="0.8 0.8 0.8" position="0 0 0"></a-entity>
  </a-marker>

  <a-marker type="pattern" url="pattern-shawarma.patt"
    smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
    <a-entity gltf-model="shawarma.glb" scale="0.5 0.5 0.5" position="0 0 0"></a-entity>
  </a-marker>

  <a-marker type="pattern" url="pattern-burger.patt"
    smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
    <a-entity gltf-model="burger.glb" scale="0.3 0.3 0.3" position="0 0 0"></a-entity>
  </a-marker>

  <a-entity camera></a-entity>
</a-scene>

<script>
  const overlay = document.getElementById('ui-overlay');

  function hideOverlay() {
    overlay.classList.add('hidden');
    setTimeout(() => overlay.style.display = 'none', 700);
  }

  const scene = document.querySelector('a-scene');
  scene.addEventListener('loaded', () => setTimeout(hideOverlay, 800));
  setTimeout(hideOverlay, 7000); // hard fallback

  // ---- ANDROID CHROME CAMERA FULLSCREEN FIX ----
  // AR.js injects <video> dynamically AND keeps overriding its style.
  // We use a MutationObserver to catch it immediately and re-patch on every style change.
  function patchVideo(video) {
    function applyStyles() {
      video.setAttribute('style', [
        'position: fixed',
        'top: 0',
        'left: 0',
        'width: 100vw',
        'height: 100vh',
        'min-width: 100%',
        'min-height: 100%',
        'object-fit: cover',
        'z-index: 0',
        'transform: none',
        '-webkit-transform: none',
        'display: block'
      ].join(' !important; ') + ' !important');
    }

    applyStyles();
    video.addEventListener('loadedmetadata', applyStyles);
    video.addEventListener('play', applyStyles);
    video.addEventListener('resize', applyStyles);

    // Re-apply every time AR.js touches the style attribute
    new MutationObserver(applyStyles)
      .observe(video, { attributes: true, attributeFilter: ['style', 'width', 'height'] });
  }

  // Catch video element whenever it's added to the DOM
  new MutationObserver((mutations) => {
    for (const m of mutations) {
      for (const node of m.addedNodes) {
        if (node.nodeName === 'VIDEO') patchVideo(node);
        if (node.querySelectorAll) node.querySelectorAll('video').forEach(patchVideo);
      }
    }
  }).observe(document.documentElement, { childList: true, subtree: true });

  // Catch any video already present
  document.querySelectorAll('video').forEach(patchVideo);

  // Fix renderer on orientation change (common on Android)
  function fixRenderer() {
    if (scene.renderer) scene.renderer.setSize(window.innerWidth, window.innerHeight);
    document.querySelectorAll('canvas').forEach(c => {
      c.style.width = '100vw';
      c.style.height = '100vh';
    });
  }

  window.addEventListener('resize', fixRenderer);
  window.addEventListener('orientationchange', () => setTimeout(fixRenderer, 400));
</script>
</body>
</html>
